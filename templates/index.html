<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Smart AI Resume Analyzer & Video Interviewer</title>
        <style>
            * {
                margin: 0;
                padding: 0;
                box-sizing: border-box;
            }

            body {
                font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                min-height: 100vh;
                padding: 20px;
            }

            .container {
                max-width: 1000px;
                margin: 0 auto;
                background: white;
                border-radius: 10px;
                box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
                overflow: hidden;
            }

            .header {
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                color: white;
                padding: 40px 20px;
                text-align: center;
            }

            .header h1 {
                font-size: 2.5em;
                margin-bottom: 10px;
            }

            .header .subtitle {
                font-size: 1.1em;
                opacity: 0.9;
            }

            .content {
                padding: 40px;
            }

            .section {
                margin-bottom: 40px;
                display: none;
            }

            .section.active {
                display: block;
                animation: slideIn 0.3s ease;
            }

            @keyframes slideIn {
                from {
                    opacity: 0;
                    transform: translateY(10px);
                }
                to {
                    opacity: 1;
                    transform: translateY(0);
                }
            }

            .form-group {
                margin-bottom: 20px;
            }

            label {
                display: block;
                margin-bottom: 8px;
                font-weight: 600;
                color: #333;
            }

            input[type="text"],
            input[type="email"],
            input[type="file"],
            textarea {
                width: 100%;
                padding: 12px;
                border: 2px solid #ddd;
                border-radius: 5px;
                font-size: 1em;
                font-family: inherit;
                transition: border-color 0.3s;
            }

            input:focus,
            textarea:focus {
                outline: none;
                border-color: #667eea;
            }

            textarea {
                resize: vertical;
                min-height: 120px;
            }

            button {
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                color: white;
                padding: 12px 30px;
                border: none;
                border-radius: 5px;
                font-size: 1em;
                cursor: pointer;
                transition: all 0.3s;
                font-weight: 600;
            }

            button:hover {
                transform: translateY(-2px);
                box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
            }

            button:disabled {
                opacity: 0.6;
                cursor: not-allowed;
                transform: none;
            }

            button.secondary {
                background: #95a5a6;
            }

            button.danger {
                background: #e74c3c;
            }

            .skill-badge {
                display: inline-block;
                background: #667eea;
                color: white;
                padding: 8px 15px;
                border-radius: 20px;
                margin: 5px 5px 5px 0;
                font-size: 0.9em;
            }

            .question-box {
                background: #f8f9fa;
                padding: 20px;
                border-radius: 8px;
                margin-bottom: 20px;
                border-left: 4px solid #667eea;
            }

            .question-text {
                font-size: 1.2em;
                font-weight: 600;
                margin-bottom: 10px;
                color: #333;
            }

            .question-meta {
                font-size: 0.9em;
                color: #666;
                margin-bottom: 15px;
            }

            .video-container {
                position: relative;
                background: #000;
                border-radius: 8px;
                overflow: hidden;
                margin: 20px 0;
            }

            #videoPreview {
                width: 100%;
                max-height: 400px;
                display: block;
            }

            .transcription-box {
                background: #e7f3ff;
                border: 2px solid #667eea;
                border-radius: 8px;
                padding: 20px;
                margin: 20px 0;
                min-height: 100px;
                max-height: 200px;
                overflow-y: auto;
            }

            .transcription-box h4 {
                color: #667eea;
                margin-bottom: 10px;
                font-size: 1.1em;
            }

            .transcription-text {
                font-size: 1.1em;
                line-height: 1.6;
                color: #333;
                font-family: 'Georgia', serif;
            }

            .transcription-text.empty {
                color: #999;
                font-style: italic;
            }

            .transcription-loading {
                color: #667eea;
                font-style: italic;
            }

            .recording-controls {
                display: flex;
                gap: 10px;
                margin: 20px 0;
                flex-wrap: wrap;
            }

            .recording-status {
                display: flex;
                align-items: center;
                gap: 10px;
                padding: 15px;
                background: #f0f0f0;
                border-radius: 5px;
                margin: 15px 0;
            }

            .recording-indicator {
                width: 12px;
                height: 12px;
                background: red;
                border-radius: 50%;
                animation: pulse 1s infinite;
            }

            .recording-indicator.inactive {
                background: #ccc;
                animation: none;
            }

            @keyframes pulse {
                0%,
                100% {
                    opacity: 1;
                    transform: scale(1);
                }
                50% {
                    opacity: 0.5;
                    transform: scale(1.1);
                }
            }

            .timer {
                font-family: 'Courier New', monospace;
                font-size: 1.2em;
                font-weight: bold;
                color: #333;
            }

            .score-display {
                font-size: 3em;
                font-weight: bold;
                color: #667eea;
                text-align: center;
                margin: 30px 0;
            }

            .score-breakdown {
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
                gap: 15px;
                margin: 20px 0;
            }

            .score-card {
                background: #f8f9fa;
                padding: 20px;
                border-radius: 8px;
                text-align: center;
                border-left: 4px solid #667eea;
            }

            .score-card-title {
                font-size: 0.9em;
                color: #666;
                margin-bottom: 10px;
            }

            .score-card-value {
                font-size: 2em;
                font-weight: bold;
                color: #667eea;
            }

            .rating-badge {
                display: inline-block;
                padding: 12px 24px;
                border-radius: 5px;
                font-weight: bold;
                color: white;
                font-size: 1.1em;
            }

            .rating-excellent        { background: #27ae60; }
            .rating-verygood         { background: #3498db; }
            .rating-good             { background: #f39c12; }
            .rating-fair             { background: #e67e22; }
            .rating-needsimprovement { background: #e74c3c; }

            .progress-bar {
                width: 100%;
                height: 10px;
                background: #ddd;
                border-radius: 5px;
                overflow: hidden;
                margin-bottom: 20px;
            }

            .progress-fill {
                height: 100%;
                background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
                transition: width 0.3s;
            }

            .status-message {
                padding: 15px;
                border-radius: 5px;
                margin-bottom: 20px;
                font-weight: 500;
            }

            .status-success {
                background: #d4edda;
                color: #155724;
                border: 1px solid #c3e6cb;
            }

            .status-error {
                background: #f8d7da;
                color: #721c24;
                border: 1px solid #f5c6cb;
            }

            .status-info {
                background: #d1ecf1;
                color: #0c5460;
                border: 1px solid #bee5eb;
            }

            .recommendations {
                background: #fff3cd;
                padding: 20px;
                border-left: 4px solid #ffc107;
                border-radius: 5px;
                margin-bottom: 20px;
            }

            .recommendations h3 {
                margin-bottom: 15px;
                color: #856404;
            }

            .recommendations ul {
                margin-left: 20px;
            }

            .recommendations li {
                margin: 8px 0;
                color: #856404;
                line-height: 1.6;
            }

            .details-table {
                width: 100%;
                border-collapse: collapse;
                margin-top: 20px;
            }

            .details-table th,
            .details-table td {
                border: 1px solid #ddd;
                padding: 12px;
                text-align: left;
            }

            .details-table th {
                background: #f5f5f5;
                font-weight: 600;
            }

            .button-group {
                display: flex;
                gap: 10px;
                flex-wrap: wrap;
            }

            .button-group button {
                flex: 1;
                min-width: 150px;
            }

            .loading {
                display: inline-block;
                width: 20px;
                height: 20px;
                border: 3px solid #f3f3f3;
                border-top: 3px solid #667eea;
                border-radius: 50%;
                animation: spin 1s linear infinite;
            }

            @keyframes spin {
                0%   { transform: rotate(0deg); }
                100% { transform: rotate(360deg); }
            }

            .hidden {
                display: none !important;
            }

            .answer-mode-toggle {
                background: #e7f3ff;
                padding: 15px;
                border-radius: 5px;
                margin-bottom: 20px;
            }

            .answer-mode-toggle label {
                display: inline;
                margin-right: 20px;
                font-weight: normal;
            }

            .answer-mode-toggle input[type="radio"] {
                margin-right: 5px;
            }

            .info-banner {
                background: #fff3cd;
                border-left: 4px solid #ffc107;
                padding: 15px;
                margin-bottom: 20px;
                border-radius: 5px;
            }

            .info-banner strong {
                color: #856404;
            }
        </style>
    </head>
    <body>
        <div class="container">
            <div class="header">
                <h1>ü§ñ Smart AI Resume Analyzer</h1>
                <p class="subtitle">Intelligent Video Interview with Real-Time Transcription</p>
            </div>

            <div class="content">

                <!-- Section 1: Resume Upload -->
                <div id="resumeSection" class="section active">
                    <h2>üìÑ Step 1: Upload Your Resume</h2>
                    <p style="color: #666; margin-bottom: 20px;">Upload your resume to extract technical skills and start the interview</p>

                    <div id="resumeMessage"></div>

                    <div class="form-group">
                        <label>Full Name *</label>
                        <input type="text" id="candidateName" placeholder="Enter your full name" required>
                    </div>

                    <div class="form-group">
                        <label>Resume File (PDF or DOCX) *</label>
                        <input type="file" id="resumeFile" accept=".pdf,.docx" required>
                        <small style="color: #666; margin-top: 5px; display: block;">Supported formats: PDF, DOCX (Max 100MB)</small>
                    </div>

                    <button onclick="uploadResume()" id="uploadBtn">üì§ Upload & Extract Skills</button>
                </div>

                <!-- Section 2: Skills Review -->
                <div id="skillsSection" class="section">
                    <h2>‚≠ê Step 2: Review Extracted Skills</h2>
                    <p style="color: #666; margin-bottom: 20px;">
                        These are the top skills identified in your resume.
                        <strong>You'll answer exactly 10 questions</strong> covering these skills.
                    </p>

                    <div id="extractedSkills"></div>

                    <button onclick="startInterview()" style="margin-top: 20px;">üéØ Start Interview (10 Questions)</button>
                </div>

                <!-- Section 3: Interview Questions -->
                <div id="interviewSection" class="section">
                    <h2>‚ùì Step 3: Interview Questions</h2>
                    <p id="questionCounter" style="color: #666; margin-bottom: 10px;">Question 1 of 10</p>

                    <div class="progress-bar">
                        <div id="progressFill" class="progress-fill" style="width: 10%;"></div>
                    </div>

                    <div id="questionContainer"></div>

                    <!-- Answer Mode Selection -->
                    <div class="answer-mode-toggle">
                        <strong>Answer Method:</strong><br><br>
                        <label>
                            <input type="radio" name="answerMode" value="video" checked>
                            üìπ Video Answer (Recommended - See transcription in real-time)
                        </label>
                        <label>
                            <input type="radio" name="answerMode" value="text">
                            ‚å®Ô∏è Text Answer
                        </label>
                    </div>

                    <!-- Important Info Banner -->
                    <div class="info-banner">
                        <strong>üí° How it works:</strong>
                        Your spoken answer will be automatically transcribed to text below and compared with the expected answer for scoring.
                    </div>

                    <!-- Video Recording Section -->
                    <div id="videoSection">
                        <div class="video-container">
                            <video id="videoPreview" autoplay muted playsinline></video>
                        </div>

                        <!-- REAL-TIME TRANSCRIPTION DISPLAY -->
                        <div class="transcription-box">
                            <h4>üìù What you're saying (Live Transcription):</h4>
                            <div id="liveTranscription" class="transcription-text empty">
                                Click "Enable Camera" to start...
                            </div>
                        </div>

                        <div class="recording-status">
                            <span class="recording-indicator inactive" id="recordIndicator"></span>
                            <span id="recordingStatus">Click "Enable Camera" to start</span>
                            <span class="timer" id="recordingTimer">00:00</span>
                        </div>

                        <div class="recording-controls">
                            <button onclick="enableCamera()" id="enableCameraBtn">üì∑ Enable Camera</button>
                            <button onclick="startRecording()" id="startRecordBtn" disabled>üé• Start Recording</button>
                            <button onclick="stopRecording()" id="stopRecordBtn" class="danger" disabled>‚èπÔ∏è Stop & Submit</button>
                            <button onclick="resetRecording()" id="resetRecordBtn" class="secondary" disabled>üîÑ Reset</button>
                        </div>
                    </div>

                    <!-- Text Answer Section -->
                    <div id="textSection" class="hidden">
                        <div class="form-group">
                            <label>Your Answer</label>
                            <textarea id="answerText" placeholder="Type your detailed answer here (minimum 20 words recommended)"></textarea>
                        </div>

                        <button onclick="submitTextAnswer()" id="submitTextBtn">‚úÖ Submit Answer</button>
                    </div>
                </div>

                <!-- Section 4: Results -->
                <div id="resultsSection" class="section">
                    <h2>üìä Your Interview Results</h2>

                    <div id="scoreDisplay"></div>
                    <div id="recommendationsDisplay"></div>
                    <div id="detailedScoresDisplay"></div>

                    <div class="button-group" style="margin-top: 30px;">
                        <button onclick="downloadReport()">üì• Download Report (JSON)</button>
                        <button onclick="downloadHTMLReport()">üìÑ View Full Report (HTML)</button>
                        <button onclick="startOver()" class="secondary">üîÑ Start Over</button>
                    </div>
                </div>

            </div><!-- /.content -->
        </div><!-- /.container -->

        <script>
            let currentQuestionId  = null;
            let questionNumber     = 0;
            let totalQuestions     = 10;
            let mediaRecorder      = null;
            let recordedChunks     = [];
            let recordingTimer     = null;
            let recordingSeconds   = 0;
            let videoStream        = null;
            let finalTranscription = "";
            let cameraEnabled      = false;

            // Toggle between video and text answer modes
            document.querySelectorAll('input[name="answerMode"]').forEach(radio => {
                radio.addEventListener('change', (e) => {
                    if (e.target.value === 'video') {
                        document.getElementById('videoSection').classList.remove('hidden');
                        document.getElementById('textSection').classList.add('hidden');
                    } else {
                        document.getElementById('videoSection').classList.add('hidden');
                        document.getElementById('textSection').classList.remove('hidden');
                        stopCamera();
                    }
                });
            });

            async function enableCamera() {
                try {
                    console.log('üé• Requesting camera and microphone access...');

                    // Update UI to show we're requesting permissions
                    document.getElementById('recordingStatus').innerText = '‚è≥ Requesting camera access...';
                    document.getElementById('enableCameraBtn').disabled = true;
                    document.getElementById('enableCameraBtn').innerText = '‚è≥ Requesting...';

                    // Request permissions with proper constraints
                    videoStream = await navigator.mediaDevices.getUserMedia({
                        video: {
                            width:  { ideal: 1280 },
                            height: { ideal: 720 },
                            facingMode: "user"
                        },
                        audio: {
                            echoCancellation: true,
                            noiseSuppression: true,
                            autoGainControl: true,
                            sampleRate: 44100
                        }
                    });

                    console.log('‚úÖ Camera access granted!');
                    const videoElement = document.getElementById('videoPreview');
                    videoElement.srcObject = videoStream;
                    
                    // Wait for video to load
                    await videoElement.play().catch(e => console.log('Video play error (can be ignored):', e));
                    
                    document.getElementById('recordingStatus').innerText = 'Camera ready - Click "Start Recording"';
                    
                    // Update transcription message
                    const transcriptionDiv = document.getElementById('liveTranscription');
                    transcriptionDiv.innerText = "Click 'Start Recording' to begin...";
                    transcriptionDiv.classList.remove('empty');

                    // Enable recording buttons
                    document.getElementById('enableCameraBtn').innerText = '‚úÖ Camera Enabled';
                    document.getElementById('startRecordBtn').disabled   = false;
                    cameraEnabled = true;

                    console.log('üéâ Camera successfully enabled! Ready to record.');

                } catch (error) {
                    console.error('‚ùå Error accessing camera:', error);
                    
                    let errorMsg = 'Could not access camera/microphone. ';
                    let detailedMsg = '';

                    if (error.name === 'NotAllowedError' || error.name === 'PermissionDeniedError') {
                        errorMsg += 'Please allow camera and microphone permissions.';
                        detailedMsg = 'Click the camera icon in your browser\'s address bar to grant permissions, then click "Enable Camera" again.';
                    } else if (error.name === 'NotFoundError' || error.name === 'DevicesNotFoundError') {
                        errorMsg += 'No camera or microphone found.';
                        detailedMsg = 'Please connect a camera and microphone to your device, or switch to "Text Answer" mode below.';
                    } else if (error.name === 'NotReadableError' || error.name === 'TrackStartError') {
                        errorMsg += 'Camera is already in use.';
                        detailedMsg = 'Please close other applications using your camera (Zoom, Teams, etc.) and try again.';
                    } else if (error.name === 'OverconstrainedError') {
                        errorMsg += 'Camera settings not supported.';
                        detailedMsg = 'Your camera doesn\'t support the requested settings. Trying again...';
                        
                        // Try with simpler constraints
                        setTimeout(async () => {
                            try {
                                videoStream = await navigator.mediaDevices.getUserMedia({
                                    video: true,
                                    audio: true
                                });
                                document.getElementById('videoPreview').srcObject = videoStream;
                                document.getElementById('recordingStatus').innerText = 'Camera ready - Click "Start Recording"';
                                document.getElementById('enableCameraBtn').innerText = '‚úÖ Camera Enabled';
                                document.getElementById('startRecordBtn').disabled = false;
                                cameraEnabled = true;
                                return;
                            } catch (retryError) {
                                console.error('Retry failed:', retryError);
                            }
                        }, 1000);
                    } else {
                        errorMsg += 'Unexpected error: ' + error.message;
                        detailedMsg = 'Please try again or switch to "Text Answer" mode.';
                    }

                    // Reset button
                    document.getElementById('enableCameraBtn').disabled  = false;
                    document.getElementById('enableCameraBtn').innerText = 'üì∑ Enable Camera';
                    document.getElementById('recordingStatus').innerText = errorMsg;
                    
                    // Show detailed error
                    const transcriptionDiv = document.getElementById('liveTranscription');
                    transcriptionDiv.innerHTML = `<strong style="color: #e74c3c;">‚ö†Ô∏è ${errorMsg}</strong><br><br>${detailedMsg}`;
                    transcriptionDiv.classList.remove('empty');

                    // Show alert with option to switch to text mode
                    alert(`${errorMsg}\n\n${detailedMsg}\n\nüí° Tip: You can switch to "Text Answer" mode below to continue without video.`);
                }
            }

            function stopCamera() {
                if (videoStream) {
                    videoStream.getTracks().forEach(track => {
                        track.stop();
                        console.log('Stopped track:', track.kind);
                    });
                    videoStream = null;
                    document.getElementById('videoPreview').srcObject  = null;
                    cameraEnabled = false;
                    document.getElementById('enableCameraBtn').disabled  = false;
                    document.getElementById('enableCameraBtn').innerText = 'üì∑ Enable Camera';
                    document.getElementById('startRecordBtn').disabled   = true;
                    document.getElementById('recordingStatus').innerText = 'Click "Enable Camera" to start';
                }
            }

            async function startRecording() {
                if (!cameraEnabled || !videoStream) {
                    alert('Please enable camera first!');
                    return;
                }

                recordedChunks     = [];
                recordingSeconds   = 0;
                finalTranscription = "";

                // Clear transcription display
                const transcriptionDiv = document.getElementById('liveTranscription');
                transcriptionDiv.innerText = "üé§ Listening... Start speaking now!";
                transcriptionDiv.classList.remove('empty');

                try {
                    // Check supported MIME types
                    let mimeType = 'video/webm;codecs=vp8,opus';

                    if (!MediaRecorder.isTypeSupported(mimeType)) {
                        mimeType = 'video/webm';
                        console.log('Using fallback MIME type:', mimeType);
                    }

                    console.log('Creating MediaRecorder with MIME type:', mimeType);

                    mediaRecorder = new MediaRecorder(videoStream, {
                        mimeType: mimeType,
                        videoBitsPerSecond: 2500000
                    });

                    mediaRecorder.ondataavailable = (event) => {
                        if (event.data && event.data.size > 0) {
                            recordedChunks.push(event.data);
                            console.log('Recorded chunk:', event.data.size, 'bytes');
                        }
                    };

                    mediaRecorder.onstop = () => {
                        console.log('MediaRecorder stopped. Total chunks:', recordedChunks.length);
                        submitVideoAnswer();
                    };

                    mediaRecorder.onerror = (event) => {
                        console.error('MediaRecorder error:', event);
                        alert('Recording error: ' + event.error);
                    };

                    // Start recording ‚Äî collect data every second
                    mediaRecorder.start(1000);
                    console.log('üî¥ Recording started...');

                    // Update UI
                    document.getElementById('recordIndicator').classList.remove('inactive');
                    document.getElementById('recordingStatus').innerText  = 'üé§ Recording... (Speak clearly)';
                    document.getElementById('startRecordBtn').disabled    = true;
                    document.getElementById('stopRecordBtn').disabled     = false;
                    document.getElementById('resetRecordBtn').disabled    = false;
                    document.getElementById('enableCameraBtn').disabled   = true;

                    // Start timer
                    recordingTimer = setInterval(() => {
                        recordingSeconds++;
                        const mins = Math.floor(recordingSeconds / 60).toString().padStart(2, '0');
                        const secs = (recordingSeconds % 60).toString().padStart(2, '0');
                        document.getElementById('recordingTimer').innerText = `${mins}:${secs}`;
                    }, 1000);

                } catch (error) {
                    console.error('Error starting recording:', error);
                    alert('Error starting recording: ' + error.message + '\n\nPlease try enabling camera again or switch to text mode.');
                }
            }

            function stopRecording() {
                if (mediaRecorder && mediaRecorder.state !== 'inactive') {
                    console.log('‚èπÔ∏è Stopping MediaRecorder...');
                    mediaRecorder.stop();
                    clearInterval(recordingTimer);

                    document.getElementById('recordIndicator').classList.add('inactive');
                    document.getElementById('recordingStatus').innerText = '‚è≥ Processing... (Transcribing your answer)';
                    document.getElementById('stopRecordBtn').disabled    = true;

                    // Show processing message
                    const transcriptionDiv = document.getElementById('liveTranscription');
                    transcriptionDiv.innerHTML = '<span class="transcription-loading">üîÑ Transcribing your answer... This may take 10-30 seconds...</span>';
                }
            }

            function resetRecording() {
                if (mediaRecorder && mediaRecorder.state === 'recording') {
                    mediaRecorder.stop();
                }

                recordedChunks     = [];
                recordingSeconds   = 0;
                finalTranscription = "";
                clearInterval(recordingTimer);

                // Reset transcription display
                const transcriptionDiv = document.getElementById('liveTranscription');
                transcriptionDiv.innerText = "Click 'Start Recording' to begin...";
                transcriptionDiv.classList.add('empty');

                document.getElementById('recordIndicator').classList.add('inactive');
                document.getElementById('recordingStatus').innerText = 'Camera ready - Click "Start Recording"';
                document.getElementById('recordingTimer').innerText  = '00:00';
                document.getElementById('startRecordBtn').disabled   = false;
                document.getElementById('stopRecordBtn').disabled    = true;
                document.getElementById('resetRecordBtn').disabled   = false;
            }

            async function submitVideoAnswer() {
                if (recordedChunks.length === 0) {
                    alert('No recording found. Please record your answer first.');
                    resetRecording();
                    return;
                }

                console.log('Creating video blob from', recordedChunks.length, 'chunks');
                const blob = new Blob(recordedChunks, { type: 'video/webm' });
                console.log('Video blob size:', blob.size, 'bytes');

                if (blob.size < 1000) {
                    alert('Recording is too short or empty. Please try again.');
                    resetRecording();
                    return;
                }

                const formData = new FormData();
                formData.append('question_id', currentQuestionId);
                formData.append('video_file', blob, 'answer.webm');
                formData.append('answer', '');

                document.getElementById('recordingStatus').innerText = 'üîÑ Uploading and transcribing...';

                try {
                    console.log('Uploading video to server...');
                    const response = await fetch('/api/submit-answer', {
                        method: 'POST',
                        body: formData
                    });

                    const data = await response.json();
                    console.log('Server response:', data);

                    if (data.success) {
                        console.log('Evaluation:', data.evaluation);

                        // DISPLAY TRANSCRIPTION TO USER
                        if (data.transcription) {
                            finalTranscription = data.transcription;
                            const transcriptionDiv = document.getElementById('liveTranscription');
                            transcriptionDiv.innerHTML = `<strong>‚úÖ Your answer:</strong> "${finalTranscription}"`;
                            transcriptionDiv.classList.remove('empty');

                            console.log('Transcription:', finalTranscription);

                            // Show for 3 seconds before moving to next question
                            setTimeout(() => {
                                resetRecording();
                                getNextQuestion();
                            }, 3000);
                        } else {
                            alert('‚ö†Ô∏è Transcription failed. Please try again or use text mode.');
                            resetRecording();
                        }
                    } else {
                        alert('Error: ' + data.error);
                        document.getElementById('recordingStatus').innerText = 'Error - Try again';
                        resetRecording();
                    }
                } catch (error) {
                    console.error('Error submitting video:', error);
                    alert('Error submitting answer: ' + error);
                    document.getElementById('recordingStatus').innerText = 'Error - Try again';
                    resetRecording();
                }
            }

            async function uploadResume() {
                const name = document.getElementById('candidateName').value.trim();
                const file = document.getElementById('resumeFile').files[0];

                if (!name || !file) {
                    showMessage('resumeMessage', 'Please enter your name and select a resume file', 'error');
                    return;
                }

                const uploadBtn = document.getElementById('uploadBtn');
                uploadBtn.disabled   = true;
                uploadBtn.innerHTML  = '<span class="loading"></span> Processing Resume...';

                const formData = new FormData();
                formData.append('name', name);
                formData.append('file', file);

                try {
                    const response = await fetch('/api/upload-resume', {
                        method: 'POST',
                        body: formData
                    });

                    const data = await response.json();

                    if (data.success) {
                        showMessage('resumeMessage', `‚úì Successfully extracted ${data.total_skills} skills!`, 'success');
                        displayExtractedSkills(data.top_skills);
                        showSection('skillsSection');
                    } else {
                        showMessage('resumeMessage', 'Error: ' + data.error, 'error');
                    }
                } catch (error) {
                    showMessage('resumeMessage', 'Error uploading resume: ' + error, 'error');
                } finally {
                    uploadBtn.disabled  = false;
                    uploadBtn.innerHTML = 'üì§ Upload & Extract Skills';
                }
            }

            function displayExtractedSkills(skills) {
                const skillsHtml = skills.map(skill =>
                    `<span class="skill-badge">${skill}</span>`
                ).join('');

                document.getElementById('extractedSkills').innerHTML =
                    `<h3 style="margin-bottom: 15px;">üéØ Top Skills Identified:</h3>
                    <p style="color: #666; margin-bottom: 15px;">You'll be asked <strong>10 questions</strong> covering these skills:</p>
                    <div>${skillsHtml}</div>`;
            }

            async function startInterview() {
                try {
                    const response = await fetch('/api/start-interview', {
                        method: 'POST'
                    });

                    const data = await response.json();

                    if (data.success) {
                        totalQuestions = data.total_questions;
                        showSection('interviewSection');
                        
                        // Load first question
                        getNextQuestion();
                        
                        // Don't auto-enable camera - let user click the button
                        // This is more reliable across different browsers
                        console.log('Interview started. User can enable camera when ready.');
                    } else {
                        alert('Error: ' + data.error);
                    }
                } catch (error) {
                    alert('Error starting interview: ' + error);
                }
            }

            async function getNextQuestion() {
                try {
                    const response = await fetch('/api/get-next-question');
                    const data = await response.json();

                    if (data.success) {
                        currentQuestionId = data.question_id;
                        questionNumber    = data.question_number;
                        totalQuestions    = data.total_questions;

                        document.getElementById('questionCounter').innerText =
                            `Question ${questionNumber} of ${totalQuestions}`;

                        document.getElementById('progressFill').style.width =
                            `${(questionNumber / totalQuestions) * 100}%`;

                        const questionHtml = `
                            <div class="question-box">
                                <div class="question-text">Q${questionNumber}: ${data.question}</div>
                                <div class="question-meta">
                                    üìÇ Category: ${data.category} |
                                    üìä Difficulty: ${data.difficulty.charAt(0).toUpperCase() + data.difficulty.slice(1)}
                                </div>
                            </div>
                        `;

                        document.getElementById('questionContainer').innerHTML = questionHtml;
                        document.getElementById('answerText').value = '';

                        // Reset for new question
                        if (cameraEnabled) {
                            resetRecording();
                        } else {
                            const transcriptionDiv = document.getElementById('liveTranscription');
                            transcriptionDiv.innerText = "Click 'Enable Camera' to start...";
                            transcriptionDiv.classList.add('empty');
                        }
                    } else {
                        // All questions completed
                        stopCamera();
                        completeInterview();
                    }
                } catch (error) {
                    alert('Error getting question: ' + error);
                }
            }

            async function submitTextAnswer() {
                const answer = document.getElementById('answerText').value.trim();

                if (!answer) {
                    alert('Please provide an answer');
                    return;
                }

                if (answer.split(' ').length < 10) {
                    alert('Please provide a more detailed answer (at least 10 words)');
                    return;
                }

                const submitBtn = document.getElementById('submitTextBtn');
                submitBtn.disabled  = true;
                submitBtn.innerHTML = '<span class="loading"></span> Evaluating...';

                const formData = new FormData();
                formData.append('question_id', currentQuestionId);
                formData.append('answer', answer);

                try {
                    const response = await fetch('/api/submit-answer', {
                        method: 'POST',
                        body: formData
                    });

                    const data = await response.json();

                    if (data.success) {
                        console.log('Evaluation:', data.evaluation);
                        await new Promise(r => setTimeout(r, 500));
                        getNextQuestion();
                    } else {
                        alert('Error: ' + data.error);
                    }
                } catch (error) {
                    alert('Error submitting answer: ' + error);
                } finally {
                    submitBtn.disabled  = false;
                    submitBtn.innerHTML = '‚úÖ Submit Answer';
                }
            }

            async function completeInterview() {
                try {
                    const response = await fetch('/api/get-interview-summary');
                    const data = await response.json();

                    if (data.success) {
                        displayResults(data.final_report);
                        showSection('resultsSection');
                    } else {
                        alert('Error: ' + data.error);
                    }
                } catch (error) {
                    alert('Error getting results: ' + error);
                }
            }

            function displayResults(report) {
                const perf         = report.interview_performance;
                const scorePercent = (perf.overall_score * 100).toFixed(1);
                const ratingClass  = `rating-${perf.rating.toLowerCase().replace(/\s/g, '')}`;

                const scoreHtml = `
                    <div style="text-align: center; margin-bottom: 30px;">
                        <div class="score-display">${scorePercent}%</div>
                        <div style="margin-bottom: 15px;">
                            <span class="rating-badge ${ratingClass}">${perf.rating}</span>
                        </div>
                        <p style="color: #666; font-size: 1.1em;">
                            ‚úì ${perf.questions_asked} questions answered ‚Ä¢
                            ‚è±Ô∏è ${perf.interview_duration_minutes.toFixed(1)} minutes
                        </p>
                    </div>

                    <div class="score-breakdown">
                        <div class="score-card">
                            <div class="score-card-title">üìù Content Accuracy</div>
                            <div class="score-card-value">${(perf.content_average * 100).toFixed(0)}%</div>
                        </div>
                        <div class="score-card">
                            <div class="score-card-title">üé§ Audio Quality</div>
                            <div class="score-card-value">${(perf.audio_average * 100).toFixed(0)}%</div>
                        </div>
                        <div class="score-card">
                            <div class="score-card-title">üë§ Video Presence</div>
                            <div class="score-card-value">${(perf.video_average * 100).toFixed(0)}%</div>
                        </div>
                    </div>
                `;

                document.getElementById('scoreDisplay').innerHTML = scoreHtml;

                const recommendationsHtml = `
                    <div class="recommendations">
                        <h3>üìã Recommendations for Improvement</h3>
                        <ul>
                            ${report.recommendations.map(rec => `<li>${rec}</li>`).join('')}
                        </ul>
                    </div>
                `;

                document.getElementById('recommendationsDisplay').innerHTML = recommendationsHtml;

                const detailsHtml = `
                    <h3 style="margin-top: 30px; margin-bottom: 15px;">üìä Detailed Question Scores</h3>
                    <table class="details-table">
                        <thead>
                            <tr>
                                <th style="width: 35%">Question</th>
                                <th>Category</th>
                                <th>Content</th>
                                <th>Audio</th>
                                <th>Video</th>
                                <th>Total</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${report.detailed_analysis.map(item => `
                                <tr>
                                    <td>${item.question.substring(0, 45)}...</td>
                                    <td>${item.category}</td>
                                    <td>${(item.content_score.total_score * 100).toFixed(0)}%</td>
                                    <td>${(item.audio_score * 100).toFixed(0)}%</td>
                                    <td>${(item.video_score * 100).toFixed(0)}%</td>
                                    <td><strong>${(item.composite_score * 100).toFixed(0)}%</strong></td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                `;

                document.getElementById('detailedScoresDisplay').innerHTML = detailsHtml;
            }

            function downloadReport() {
                window.location.href = '/api/download-report';
            }

            function downloadHTMLReport() {
                window.open('/final_report.html', '_blank');
            }

            function startOver() {
                if (confirm('Are you sure you want to start over? All progress will be lost.')) {
                    stopCamera();
                    location.reload();
                }
            }

            function showSection(sectionId) {
                document.querySelectorAll('.section').forEach(section => {
                    section.classList.remove('active');
                });
                document.getElementById(sectionId).classList.add('active');
                window.scrollTo(0, 0);
            }

            function showMessage(elementId, message, type) {
                const element = document.getElementById(elementId);
                element.innerHTML = `<div class="status-message status-${type}">${message}</div>`;
            }

            // Cleanup on page unload
            window.addEventListener('beforeunload', () => {
                stopCamera();
            });
        </script>
    </body>
</html>